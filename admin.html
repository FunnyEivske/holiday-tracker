<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Tracker Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOcFfiRIw3sgU9eqEbwc1uc_Ur1aTOJXk",
            authDomain: "ferie-805e0.firebaseapp.com",
            projectId: "ferie-805e0",
            storageBucket: "ferie-805e0.firebasestorage.app",
            messagingSenderId: "621338557882",
            appId: "1:621338557882:web:9eae6887a484db316d7183",
            measurementId: "G-C8PT9DKJ3Q"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'holiday-tracker-main';

        async function init() {
            try {
                await signInAnonymously(auth);
                startListening();
            } catch (error) {
                console.error("Auth", error);
            }
        }

        function startListening() {
            // Path: artifacts/{appId}/private/sessions
            const col = collection(db, 'artifacts', appId, 'private', 'sessions');

            onSnapshot(col, (snapshot) => {
                const list = document.getElementById('session-list');
                list.innerHTML = '';

                const now = new Date();

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const lastSeen = new Date(data.lastSeen);
                    const diffSeconds = (now - lastSeen) / 1000;

                    // Filter out very old sessions (> 1 hour?) or keep them to clean up?
                    // Let's mark them as offline if > 2 mins
                    const isOnline = diffSeconds < 120;

                    if (diffSeconds > 3600 * 24) {
                        // Optional: clean up dead sessions automatically?
                        // deleteDoc(docSnap.ref);
                        // return;
                    }

                    const card = document.createElement('div');
                    card.className = `p-4 rounded-xl border-2 flex flex-col gap-3 ${isOnline ? 'bg-slate-800 border-green-500/50' : 'bg-slate-900 border-gray-700 opacity-70'}`;

                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-white font-bold text-lg">Display: ${id.substr(0, 4)}...</h3>
                                <p class="text-xs text-gray-400 font-mono">${data.resolution} - ${data.userAgent.replace(/Mozilla.*?\)/, '')}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-bold ${isOnline ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                ${isOnline ? 'ONLINE' : 'OFFLINE'}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-300">
                            <div class="bg-black/30 p-2 rounded">
                                <span class="text-gray-500 text-xs uppercase">View</span><br>
                                ${data.currentView}
                            </div>
                            <div class="bg-black/30 p-2 rounded">
                                <span class="text-gray-500 text-xs uppercase">Screensaver</span><br>
                                ${data.screensaver}
                            </div>
                        </div>

                        ${isOnline ? `
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button onclick="sendCommand('${id}', 'set_view:dashboard')" class="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-sm font-bold">
                                Show Dashboard
                            </button>
                            <button onclick="sendCommand('${id}', 'set_view:tracker')" class="bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded text-sm font-bold">
                                Show Tracker
                            </button>
                            <button onclick="sendCommand('${id}', 'trigger_screensaver:cleaning')" class="col-span-2 bg-yellow-600 hover:bg-yellow-500 text-white py-2 rounded text-sm font-bold flex items-center justify-center gap-2">
                                <span>ðŸ§¹</span> Start Cleaning Mode (10m)
                            </button>
                            <button onclick="sendCommand('${id}', 'trigger_screensaver:night')" class="bg-purple-600 hover:bg-purple-500 text-white py-2 rounded text-sm font-bold">
                                Force Night Mode
                            </button>
                            <button onclick="sendCommand('${id}', 'trigger_screensaver:off')" class="bg-gray-600 hover:bg-gray-500 text-white py-2 rounded text-sm font-bold">
                                Wake Up
                            </button>
                        </div>
                        ` : `
                        <button onclick="deleteSession('${id}')" class="w-full bg-red-900/50 hover:bg-red-900 text-red-200 py-2 rounded text-sm">
                            Remove Dead Session
                        </button>
                        `}
                    `;
                    list.appendChild(card);
                });

                if (list.innerHTML === '') {
                    list.innerHTML = '<p class="text-gray-500 text-center py-10">No active sessions found.</p>';
                }
            });
        }

        window.sendCommand = async function (sessionId, cmd) {
            const ref = doc(db, 'artifacts', appId, 'private', 'sessions', sessionId);
            try {
                await updateDoc(ref, { command: cmd });
                console.log("Sent", cmd, "to", sessionId);
            } catch (e) {
                console.error("Send failed", e);
                alert("Failed to send command");
            }
        }

        window.deleteSession = async function (sessionId) {
            if (!confirm("Remove this session?")) return;
            const ref = doc(db, 'artifacts', appId, 'private', 'sessions', sessionId);
            await deleteDoc(ref);
        }

        init();
    </script>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <header class="flex items-center justify-between mb-8 pb-4 border-b border-slate-800">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Control Center
            </h1>
            <div class="text-xs text-gray-500">Holiday Tracker Admin</div>
        </header>

        <div id="session-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Sessions go here -->
            <div class="col-span-full text-center text-gray-500 animate-pulse">Loading sessions...</div>
        </div>
    </div>
</body>

</html>
<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juleferie Oversikt - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Nunito:wght@400;700;800&display=swap"
        rel="stylesheet">

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config & Init ---
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCOcFfiRIw3sgU9eqEbwc1uc_Ur1aTOJXk",
            authDomain: "ferie-805e0.firebaseapp.com",
            projectId: "ferie-805e0",
            storageBucket: "ferie-805e0.firebasestorage.app",
            messagingSenderId: "621338557882",
            appId: "1:621338557882:web:9eae6887a484db316d7183",
            measurementId: "G-C8PT9DKJ3Q"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'holiday-tracker-main'; // Simple static ID for your app's data path

        let currentUser = null;
        let allEmployees = [];
        let currentPage = 0;
        const itemsPerPage = 10;
        let rotationInterval;

        // Farge-temaer
        // Nord Theme Palette
        const nord = {
            nord0: '#2e3440', nord1: '#3b4252', nord2: '#434c5e', nord3: '#4c566a', // Polar Night
            nord4: '#d8dee9', nord5: '#e5e9f0', nord6: '#eceff4', // Snow Storm
            nord7: '#8fbcbb', nord8: '#88c0d0', nord9: '#81a1c1', nord10: '#5e81ac', // Frost
            nord11: '#bf616a', nord12: '#d08770', nord13: '#ebcb8b', nord14: '#a3be8c', nord15: '#b48ead' // Aurora
        };

        const themes = {
            red: { bg: `linear-gradient(135deg, ${nord.nord11} 0%, #a6555d 100%)`, border: nord.nord11, shadow: 'rgba(191, 97, 106, 0.4)', textMain: 'text-[#eceff4]', textSub: 'text-[#d8dee9]', textAccent: 'text-[#81a1c1]', badge: 'bg-[#bf616a]', label: 'Juleferie' },
            pink: { bg: `linear-gradient(135deg, ${nord.nord15} 0%, #9b7295 100%)`, border: nord.nord15, shadow: 'rgba(180, 142, 173, 0.4)', textMain: 'text-[#eceff4]', textSub: 'text-[#d8dee9]', textAccent: 'text-[#88c0d0]', badge: 'bg-[#b48ead]', label: 'Ferie' },
            blue: { bg: `linear-gradient(135deg, ${nord.nord10} 0%, ${nord.nord9} 100%)`, border: nord.nord9, shadow: 'rgba(129, 161, 193, 0.4)', textMain: 'text-[#eceff4]', textSub: 'text-[#e5e9f0]', textAccent: 'text-[#8fbcbb]', badge: 'bg-[#5e81ac]', label: 'Vinterferie' },
            green: { bg: `linear-gradient(135deg, ${nord.nord14} 0%, #8ca575 100%)`, border: nord.nord14, shadow: 'rgba(163, 190, 140, 0.4)', textMain: 'text-[#eceff4]', textSub: 'text-[#d8dee9]', textAccent: 'text-[#ebcb8b]', badge: 'bg-[#a3be8c]', label: 'Fri' },
            purple: { bg: `linear-gradient(135deg, ${nord.nord15} 0%, #9b7295 100%)`, border: nord.nord15, shadow: 'rgba(180, 142, 173, 0.4)', textMain: 'text-[#eceff4]', textSub: 'text-[#d8dee9]', textAccent: 'text-[#88c0d0]', badge: 'bg-[#b48ead]', label: 'Ferie' }, // Same as pink for now
            orange: { bg: `linear-gradient(135deg, ${nord.nord12} 0%, #b8735d 100%)`, border: nord.nord12, shadow: 'rgba(208, 135, 112, 0.4)', textMain: 'text-[#eceff4]', textSub: 'text-[#d8dee9]', textAccent: 'text-[#ebcb8b]', badge: 'bg-[#d08770]', label: 'Solferie' },
            yellow: { bg: `linear-gradient(135deg, ${nord.nord13} 0%, #d6b779 100%)`, border: nord.nord13, shadow: 'rgba(235, 203, 139, 0.4)', textMain: 'text-[#2e3440]', textSub: 'text-[#3b4252]', textAccent: 'text-[#bf616a]', badge: 'bg-[#ebcb8b]', label: 'Fri' }, // Dark text for yellow card
            teal: { bg: `linear-gradient(135deg, ${nord.nord7} 0%, #7aa1a0 100%)`, border: nord.nord7, shadow: 'rgba(143, 188, 187, 0.4)', textMain: 'text-[#eceff4]', textSub: 'text-[#e5e9f0]', textAccent: 'text-[#5e81ac]', badge: 'bg-[#8fbcbb]', label: 'Avspasering' },
        };

        // --- Auth & Data Loading ---
        async function initApp() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth error", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                startListening();
            }
        });

        function startListening() {
            const currentSeason = getSeason();
            // Store data in a sub-collection named after the season (e.g., 'christmas', 'winter', 'summer')
            // Path: artifacts/{appId}/public/data/{seasonName}
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', currentSeason));

            onSnapshot(q, (snapshot) => {
                const employees = [];
                snapshot.forEach((doc) => {
                    employees.push({ id: doc.id, ...doc.data() });
                });

                employees.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                allEmployees = employees;

                renderGrid();
                updatePaginationDots();
            }, (error) => {
                console.error("Data fetch error:", error);
            });
        }



        // --- Rendering Logic ---
        window.renderGrid = function () {
            const grid = document.getElementById('employee-grid');
            grid.innerHTML = '';

            const totalPages = Math.ceil(allEmployees.length / itemsPerPage);
            if (currentPage >= totalPages) currentPage = 0;

            const start = currentPage * itemsPerPage;
            const end = start + itemsPerPage;
            const currentItems = allEmployees.slice(start, end);

            currentItems.forEach(emp => {
                const card = createCard(emp);
                grid.appendChild(card);
            });

            grid.classList.remove('fade-in');
            void grid.offsetWidth;
            grid.classList.add('fade-in');
        }

        function createCard(emp) {
            const startD = new Date(emp.startDate);
            const endD = new Date(emp.endDate);

            const formatNB = (date) => {
                const d = date.getDate();
                const m = ["Januar", "Februar", "Mars", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Desember"][date.getMonth()];
                return `${d}. ${m}`;
            };
            const getDayNB = (date) => {
                const days = ["SÃ¸ndag", "Mandag", "Tirsdag", "Onsdag", "Torsdag", "Fredag", "LÃ¸rdag"];
                return days[date.getDay()];
            };

            // Bakoverkompatibilitet for gammel data
            let colorKey = emp.color;
            if (!colorKey) {
                // Hvis data mangler 'color', gjett basert pÃ¥ gammel 'type'
                if (emp.type === 'pink') colorKey = 'pink';
                else colorKey = 'red';
            }

            let emoji = emp.emoji;
            if (!emoji) {
                emoji = (colorKey === 'pink') ? 'ðŸŽ…' : 'ðŸŽ„';
            }

            const theme = themes[colorKey] || themes.red;

            const currentSeason = getSeason();
            const seasonLabel = (currentSeason && seasonConfig[currentSeason]) ? seasonConfig[currentSeason].title : "Ferie";

            const div = document.createElement('div');
            div.className = `rounded-3xl p-6 relative transform transition duration-300 h-full flex flex-col justify-between`;
            div.style.background = theme.bg;
            div.style.border = `4px solid ${theme.border}`;
            div.style.boxShadow = `0 0 20px ${theme.shadow}`;

            div.innerHTML = `
                <div class="absolute -top-4 -right-4 ${theme.badge} text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg border-2 border-white">
                    ${emoji}
                </div>
                <div>
                    <h2 class="text-3xl font-bold ${theme.textMain} mb-1 truncate">${emp.name}</h2>
                    <p class="text-md ${theme.textSub} font-semibold mb-4 uppercase tracking-wider">${seasonLabel} / Fri</p>
                    
                <div class="space-y-3">
                        <div class="bg-[#2e3440]/40 rounded-xl p-3 shadow-sm border border-[#4c566a]/30">
                            <p class="text-xs text-[#d8dee9] uppercase font-bold shadow-black drop-shadow-sm">Starter:</p>
                            <p class="text-2xl text-[#eceff4] font-bold leading-none mt-1 drop-shadow-md">${formatNB(startD)}</p>
                            <p class="${theme.textAccent} font-medium text-sm drop-shadow-sm">${getDayNB(startD)}</p>
                        </div>
                        
                        <div class="flex justify-center text-xl ${theme.textAccent} drop-shadow-md">â¬‡</div>
                        
                        <div class="bg-[#2e3440]/40 rounded-xl p-3 shadow-sm border border-[#4c566a]/30">
                            <p class="text-xs text-[#d8dee9] uppercase font-bold shadow-black drop-shadow-sm">Slutter:</p>
                            <p class="text-2xl text-[#eceff4] font-bold leading-none mt-1 drop-shadow-md">${formatNB(endD)}</p>
                            <p class="${theme.textAccent} font-medium text-sm drop-shadow-sm">${getDayNB(endD)}</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-center bg-[#2e3440]/30 rounded-lg p-2 border border-[#4c566a]/20">
                    <p class="${theme.textMain} font-bold text-sm drop-shadow-md">âœ¨ ${emoji} God Ferie ${emoji} âœ¨</p>
                </div>
                
                <button onclick="window.deleteItem('${emp.id}')" class="absolute bottom-2 right-2 text-gray-400 hover:text-red-600 opacity-20 hover:opacity-100 transition z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                </button>
            `;
            return div;
        }

        // --- Rotation Logic ---
        function startRotation() {
            if (rotationInterval) clearInterval(rotationInterval);
            rotationInterval = setInterval(() => {
                const totalPages = Math.ceil(allEmployees.length / itemsPerPage);
                if (totalPages > 1) {
                    currentPage++;
                    if (currentPage >= totalPages) currentPage = 0;
                    renderGrid();
                    updatePaginationDots();
                }
            }, 10000);
        }

        startRotation();

        function updatePaginationDots() {
            const container = document.getElementById('pagination-dots');
            container.innerHTML = '';
            const totalPages = Math.ceil(allEmployees.length / itemsPerPage);

            if (totalPages <= 1) return;

            for (let i = 0; i < totalPages; i++) {
                const dot = document.createElement('div');
                dot.className = `w-3 h-3 rounded-full mx-1 transition-all duration-300 ${i === currentPage ? 'bg-yellow-400 scale-125' : 'bg-white/30'}`;
                container.appendChild(dot);
            }
        }

        // --- Selection Logic ---




        window.deleteItem = async function (id) {
            if (confirm("Slette denne oppfÃ¸ringen?")) {
                const currentSeason = getSeason();
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', currentSeason, id));
            }
        }

        initApp();

    </script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: radial-gradient(circle at center, #2e3440 0%, #242933 100%);
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        .christmas-font {
            font-family: 'Mountains of Christmas', cursive;
        }




        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Skjul scrollbar i emoji-velgeren */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="flex flex-col h-full">

    <canvas id="snow-canvas" class="fixed inset-0 pointer-events-none z-10 hidden"></canvas>

    <!-- Main Content (Scrollable) -->
    <div
        class="flex-grow flex flex-col items-center justify-center p-4 pb-32 relative z-10 w-full max-w-7xl mx-auto overflow-y-auto h-full scrollbar-hide">

        <header class="text-center mb-8 shrink-0">
            <h1 class="text-5xl md:text-6xl text-yellow-300 christmas-font drop-shadow-lg font-bold">
                ðŸŽ„ Juleferie 2025 ðŸŽ„
            </h1>
            <p class="text-blue-200 mt-2 text-lg">God jul til hele gjengen!</p>
        </header>

        <div id="employee-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 w-full fade-in shrink-0">
            <div class="col-span-full text-center text-white/50 animate-pulse">Laster ferieoversikt...</div>
        </div>

        <div id="pagination-dots" class="flex justify-center mt-6 h-4 shrink-0"></div>

    </div>

    <!-- Footer (Fixed Bottom) -->
    <div class="fixed bottom-0 left-0 right-0 z-40 bg-black/60 backdrop-blur-md w-full p-4 border-t border-white/10">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">

            <div class="flex items-center gap-4">
                <div id="qrcode" class="bg-white p-2 rounded-lg"></div>
                <div class="text-white">
                    <p class="font-bold text-lg">Legg til din ferie!</p>
                    <p class="text-sm text-gray-300">Scan koden eller trykk pÃ¥ knappen</p>
                </div>
            </div>

            <!-- Registration button removed, now handled via QR Code / register.html -->
        </div>
    </div>

    <!-- DASHBOARD VIEW (Optimized for Grouping & Visibility - Nord Theme) -->
    <div id="dashboard-view" class="hidden fixed inset-0 bg-[#2e3440] z-50 flex flex-col font-sans text-[#eceff4]">

        <!-- Comics Grid Container -->
        <!-- 2 Columns ensures pairs (e.g. Lunch 1 & 2) stay on the same row -->
        <div id="comic-grid"
            class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-2 p-2 overflow-y-auto w-full max-w-[1800px] mx-auto scroll-smooth">
            <!-- Comics will be injected here -->
            <div class="col-span-full flex flex-col items-center justify-center h-full text-[#4c566a] animate-pulse">
                <span class="text-lg font-medium">Laster inn striper...</span>
            </div>
        </div>

        <!-- Footer -->
        <div
            class="min-h-[100px] bg-[#3b4252] border-t border-[#4c566a] flex items-center justify-between px-8 py-4 shrink-0 shadow-[0_-5px_20px_rgba(0,0,0,0.3)] z-20 relative">

            <!-- Left: QR Code -->
            <div class="flex items-center gap-6 w-1/5 min-w-[120px]">
                <div id="dash-qrcode" class="bg-[#eceff4] p-2 rounded-lg shadow-md shrink-0"></div>
            </div>

            <!-- Center: Quote (Full Visibility) -->
            <div class="flex-grow flex justify-center w-3/5 px-4">
                <p id="dash-quote"
                    class="text-lg md:text-xl text-[#d8dee9] italic text-center leading-normal whitespace-normal break-words border-l-4 border-[#5e81ac] pl-6 py-2">
                    "Loading wisdom..."
                </p>
            </div>

            <!-- Right: Clock & Status -->
            <div class="flex items-center justify-end gap-4 w-1/5 min-w-[150px]">
                <div id="dash-clock" class="text-4xl font-mono font-bold text-[#eceff4] tracking-wider">00:00</div>
                <!-- Status Dot -->
                <div id="connection-status"
                    class="w-3 h-3 rounded-full bg-[#bf616a] shadow-[0_0_10px_rgba(191,97,106,0.7)] transition-colors duration-500">
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const productionUrl = "https://funnyeivske.github.io/holiday-tracker/";

            // Determine base URL
            let baseUrl = window.location.href;
            if (window.location.protocol === 'file:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                if (productionUrl) {
                    baseUrl = productionUrl;
                    console.log("Local development detected. Using production URL base:", baseUrl);
                }
            }

            // Construct Target URL for Registration
            // Ensure we don't double-slash or miss a slash
            const targetUrl = baseUrl.endsWith('/')
                ? baseUrl + 'register.html'
                : baseUrl.substring(0, baseUrl.lastIndexOf('/') + 1) + 'register.html';

            const qrContainer = document.getElementById("qrcode");

            // Clean QR generation
            new QRCode(qrContainer, {
                text: targetUrl,
                width: 64,
                height: 64,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            Dashboard.init(); // Initialize NCD Dashboard

            const season = getSeason();
            if (!season) {
                // No holiday: Show Dashboard only
                startPageRotation(false);
            } else {
                // Holiday: Show App
                startPageRotation(true);
                applySeasonTheme();
            }
        });

        // --- Dashboard Logic (NCD Reverse Engineering) ---
        const Dashboard = {
            ws: null,
            reconnectDelay: 5000,
            clientId: 'hol-tracker-' + Date.now(),

            init: function () {
                this.startClock();
                this.connectWS();
                this.renderQR();
            },

            startClock: function () {
                const clockEl = document.getElementById('dash-clock');
                const update = () => {
                    const now = new Date();
                    clockEl.textContent = now.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' });
                };
                update();
                setInterval(update, 1000);
            },

            renderQR: function () {
                const qrEl = document.getElementById('dash-qrcode');
                qrEl.innerHTML = '';

                // Construct Target URL for Registration (Simple relative logic)
                // We want the kiosk QR to also let people register easily
                let baseUrl = window.location.href;
                const targetUrl = baseUrl.endsWith('/')
                    ? baseUrl + 'register.html'
                    : baseUrl.substring(0, baseUrl.lastIndexOf('/') + 1) + 'register.html';

                new QRCode(qrEl, {
                    text: targetUrl,
                    width: 80,
                    height: 80,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L
                });
            },

            connectWS: function () {
                const protocol = 'wss:';
                const host = 'ncd.idmedia.no';
                const url = `${protocol}//${host}/ws/${this.clientId}`;

                console.log('Connecting to NCD WS:', url);
                this.ws = new WebSocket(url);

                this.ws.onopen = () => {
                    console.log('NCD WS Connected');
                    const status = document.getElementById('connection-status');
                    if (status) {
                        status.classList.remove('bg-red-500');
                        status.classList.add('bg-green-500');
                        status.style.boxShadow = "0 0 8px rgba(34, 197, 94, 0.6)"; // Green glow
                    }
                    this.reconnectDelay = 5000;
                };

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.event === 'update') {
                            this.updateContent(data.data);
                        }
                    } catch (e) { console.error('WS Parse Error', e); }
                };

                this.ws.onclose = () => {
                    console.log('NCD WS Closed');
                    this.handleDisconnect();
                };

                this.ws.onerror = (err) => {
                    console.error('NCD WS Error', err);
                    this.handleDisconnect();
                };
            },

            handleDisconnect: function () {
                const status = document.getElementById('connection-status');
                if (status) {
                    status.classList.remove('bg-green-500');
                    status.classList.add('bg-red-500');
                    status.style.boxShadow = "0 0 8px rgba(239, 68, 68, 0.6)"; // Red glow
                }
                setTimeout(() => this.connectWS(), this.reconnectDelay);
                this.reconnectDelay = Math.min(this.reconnectDelay * 2, 30000);
            },

            updateContent: function (data) {
                // Update Quote
                if (data.quotes && data.quotes.sadserver) {
                    const quoteEl = document.getElementById('dash-quote');
                    if (quoteEl) quoteEl.textContent = `"${data.quotes.sadserver}"`;
                }

                // Update Comics
                if (data.comics) {
                    const grid = document.getElementById('comic-grid');
                    if (!grid) return;
                    grid.innerHTML = ''; // Clear existing

                    const sources = [
                        { domain: "vg.no", type: "Lunch" },
                        { domain: "vg.no", type: "Pappa" },
                        { domain: "tu.no", type: "Lunch" }
                    ];

                    sources.forEach(source => {
                        const domainComics = data.comics[source.domain];
                        const comicType = (domainComics && domainComics[source.type]) ? source.type : "Lunch";

                        if (domainComics && domainComics[comicType]) {
                            // Take first 2 valid images to fill 6 slots (3 sources * 2)
                            const comicsList = domainComics[comicType].slice(0, 2);

                            comicsList.forEach(imgData => {
                                const wrapper = document.createElement('div');
                                // Nord Theme Card: Nord1 Background, Nord3 Border
                                // ADDED: h-full and flex-col to ensure it fills the grid cell
                                wrapper.className = "w-full h-full bg-[#3b4252]/50 rounded-lg shadow-sm border border-[#4c566a] hover:border-[#88c0d0] transition-colors flex flex-col items-center justify-center p-2";

                                const img = document.createElement('img');
                                // Fix relative URLs
                                let src = imgData.url;
                                if (src.startsWith('/')) {
                                    src = 'https://ncd.idmedia.no' + src;
                                }
                                img.src = src;
                                // Full visibility, no clipping, fill available height
                                img.className = "w-full h-full object-contain max-h-full";

                                wrapper.appendChild(img);
                                grid.appendChild(wrapper);
                            });
                        }
                    });
                }
            }
        };

        // --- Page Logic (Kiosk Mode) ---
        function startPageRotation(isHoliday) {
            const dashboard = document.getElementById('dashboard-view');

            if (!isHoliday) {
                console.log("No holiday season active. Showing Dashboard.");
                dashboard.classList.remove('hidden');
                dashboard.classList.add('flex');
            } else {
                console.log("Holiday season active! Showing Tracker.");
                dashboard.classList.add('hidden');
                dashboard.classList.remove('flex');
            }
        }

        // --- Seasonal Logic ---
        function getSeason() {
            const date = new Date();
            const month = date.getMonth(); // 0-11
            const day = date.getDate();

            // Jul: 1. Desember - 5. Januar
            if (month === 11 || (month === 0 && day <= 5)) {
                return 'christmas';
            }
            // Vinterferie (Agder: Uke 8): Ca. 15. Februar - 1. Mars
            if (month === 1 && day >= 15 && day <= 28) { // Feb 15-28 covers Week 8 mostly
                return 'winter';
            }
            // PÃ¥ske/VÃ¥r: 1. April - 22. April (Varierer, men dekker det meste)
            if (month === 3 && day <= 22) {
                return 'spring';
            }
            // Sommer (Skoleferie): ca 20. Juni - 18. August
            if ((month === 5 && day >= 20) || month === 6 || (month === 7 && day <= 18)) {
                return 'summer';
            }
            // HÃ¸st (Agder: Uke 40): Ca 28. September - 10. Oktober
            if ((month === 8 && day >= 28) || (month === 9 && day <= 10)) {
                return 'autumn';
            }

            return null; // Ingen ferie
        }

        const seasonConfig = {
            christmas: {
                title: "Juleferie",
                titleEmoji: "ðŸŽ„",
                subtitle: "God jul til hele gjengen!",
                bg: "radial-gradient(circle at center, #2d3748 0%, #1a202c 100%)",
                headerColor: "text-yellow-300",
                font: "christmas-font",
                snow: true,
                defaultEmoji: "ðŸŽ…"
            },
            winter: {
                title: "Vinterferie",
                titleEmoji: "â›·ï¸",
                subtitle: "God vinterferie! Husk kakao!",
                bg: "radial-gradient(circle at center, #e0f2fe 0%, #0284c7 100%)", // Light blue to blue
                headerColor: "text-white",
                font: "font-sans", // Fallback to Nunito/Standard
                snow: true,
                defaultEmoji: "â›·ï¸"
            },
            spring: {
                title: "VÃ¥rferie",
                titleEmoji: "ðŸŒ±",
                subtitle: "Nyt vÃ¥ren og fridagene!",
                bg: "radial-gradient(circle at center, #dcfce7 0%, #16a34a 100%)", // Light green to green
                headerColor: "text-green-900",
                font: "font-sans",
                snow: false,
                defaultEmoji: "ðŸŒ±"
            },
            summer: {
                title: "Sommerferie",
                titleEmoji: "â˜€ï¸",
                subtitle: "God sommer! Nyt solen!",
                bg: "radial-gradient(circle at center, #fef9c3 0%, #eab308 100%)", // Light yellow to yellow
                headerColor: "text-orange-600",
                font: "font-sans",
                snow: false,
                defaultEmoji: "ðŸ–ï¸"
            },
            autumn: {
                title: "HÃ¸stferie",
                titleEmoji: "ðŸ‚",
                subtitle: "God hÃ¸stferie! Ut pÃ¥ tur!",
                bg: "radial-gradient(circle at center, #ffedd5 0%, #c2410c 100%)", // Orange to rust
                headerColor: "text-red-900",
                font: "font-sans",
                snow: false,
                defaultEmoji: "ðŸ‚"
            }
        };

        // Manual Toggle with 'X' key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'x' || e.key === 'X') {
                console.log("Manual toggle triggered");
                const dashboard = document.getElementById('dashboard-view');
                const isDashboardVisible = !dashboard.classList.contains('hidden');

                if (isDashboardVisible) {
                    // Switch to App
                    startPageRotation(true);
                    applySeasonTheme();
                } else {
                    // Switch to Dashboard
                    startPageRotation(false);
                }
            }
        });

        // --- Canvas Snow Effect (Performance Optimized) ---
        let snowFrameId = null;

        function startSnowEffect() {
            const canvas = document.getElementById('snow-canvas');
            if (!canvas) return;

            // Prevent stacking loops - STOP existing animation before starting new
            if (snowFrameId) {
                cancelAnimationFrame(snowFrameId);
                snowFrameId = null;
            }

            canvas.classList.remove('hidden');
            const ctx = canvas.getContext('2d');

            let width = window.innerWidth;
            let height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;

            const snowflakes = [];
            const count = 50; // Optimized count for low-end devices

            for (let i = 0; i < count; i++) {
                snowflakes.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    r: Math.random() * 3 + 1,
                    d: Math.random() * count,
                    speed: Math.random() * 0.5 + 0.2 // Slow, relaxing speed
                });
            }

            function draw() {
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = "rgba(236, 239, 244, 0.8)"; // Nord Snow Storm
                ctx.beginPath();
                for (let i = 0; i < count; i++) {
                    const f = snowflakes[i];
                    ctx.moveTo(f.x, f.y);
                    ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true);
                }
                ctx.fill();
                update();
                snowFrameId = requestAnimationFrame(draw);
            }

            function update() {
                for (let i = 0; i < count; i++) {
                    const f = snowflakes[i];
                    f.y += f.speed;
                    f.x += Math.sin(f.d) * 0.5; // Gentle sway

                    if (f.y > height) {
                        snowflakes[i] = { x: Math.random() * width, y: -10, r: f.r, d: f.d, speed: f.speed };
                    }
                }
            }

            // Clean up old listener to prevent duplicates (optional but good practice)
            const oldResize = window.onresize;
            window.onresize = () => {
                if (oldResize) oldResize();
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
            };

            draw();
        }

        function applySeasonTheme() {
            let season = getSeason();

            // Fallback if no season but forced to show (defaults to winter or next closest)
            if (!season) {
                season = 'winter'; // Default theme for non-holidays
            }

            const config = seasonConfig[season];
            const year = new Date().getFullYear();

            // Update Title (Emoji on both sides)
            const titleEl = document.querySelector('header h1');
            titleEl.textContent = `${config.titleEmoji} ${config.title} ${year} ${config.titleEmoji}`;

            // Remove old specific font/color classes and add new ones
            titleEl.className = `text-5xl md:text-6xl drop-shadow-lg font-bold ${config.headerColor} ${config.font}`;

            // Update Subtitle
            const subtitleEl = document.querySelector('header p');
            subtitleEl.textContent = config.subtitle;

            // Adjust subtitle color
            if (season === 'summer' || season === 'spring' || season === 'autumn') {
                subtitleEl.classList.remove('text-blue-200');
                subtitleEl.classList.add('text-gray-800');
            } else {
                subtitleEl.classList.add('text-blue-200');
                subtitleEl.classList.remove('text-gray-800');
            }

            // Update Background (Nord Theme is default, but config.bg might override or match)
            document.body.style.background = config.bg;

            // Update Snow (Canvas)
            const snowCanvas = document.getElementById('snow-canvas');
            if (config.snow) {
                if (snowCanvas) startSnowEffect();
            } else {
                if (snowCanvas) snowCanvas.classList.add('hidden');
                // Stop the loop if it's running
                if (snowFrameId) {
                    cancelAnimationFrame(snowFrameId);
                    snowFrameId = null;
                }
            }

            // Update Modal Header Emoji
            const modalHeader = document.querySelector('#modal h2');
            if (modalHeader) {
                modalHeader.textContent = `${config.defaultEmoji} NÃ¥r tar du ferie?`;
            }

            // Update Default Emoji in Modal
            // We'll override the global openModal to use the config.
            const oldOpenModal = window.openModal;
            window.openModal = function () {
                document.getElementById('modal').classList.remove('hidden');
                document.getElementById('modal').classList.add('flex');
                window.selectColor('red');
                window.selectEmoji(config.defaultEmoji);
            }
        }


    </script>
</body>

</html>